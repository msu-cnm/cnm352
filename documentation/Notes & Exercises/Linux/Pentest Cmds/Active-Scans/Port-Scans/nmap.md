## nmap - Network Map Tool

Scans are in the format of:

```bash
nmap [OPTIONS] -p [PORT(S)] [TARGETS] -o[OUTPUT OPTIONS]
```

### Host Discovery

Hosts are specified in one of the following formats:

| Syntax      | Meaning              |
| ----------- | -------------------- |
| 1.1.1.1     | Scan a single IP     |
| 1.1.1.0/24  | Scan a network       |
| 1.1.1.1-100 | Scan a range of IP's |

More host discovery options are available as well:

| Option   | Discovery Type                                      |
| -------- | --------------------------------------------------- |
| -Pn      | Treat every host as online, skipping host discovery |
| -iL FILE | Scan hosts listed in FILE                           |
| -n       | Disable name resolution                             |

### Port Syntax

| Syntax        | Meaning                                                      |
| ------------- | ------------------------------------------------------------ |
| -p (or -p-)   | Scan all ports                                               |
| -p80          | Scan one port (80)                                           |
| -p1-10        | Scan a range of ports                                        |
| -p1,3,5,7     | Scan a set of ports.                                         |
| --top-ports=X | Scan the X top most common ports in /usr/share/nmap/nmap-services |

The range and set of ports can be combined by inserting the range as one of the members of the set.

### Port Scan Options

By default, nmap scans the 1000 most popular ports and uses a Stealth (SYN) scan, unless nmap does not have raw socket privileges, at which point it defaults to the TCP Connect scan.

These flags are supplied to nmap to tell it what kind of scan to perform.  Flags can be combined as well to do more than one type of scan.

| Option | Scan Type                                                    |
| ------ | ------------------------------------------------------------ |
| -sT    | TCP Connect Scan - performs full 3-way handshake             |
| -sS    | TCP SYN Scan - sends a SYN and looks for SYN-ACK, then resets |
| -sU    | UDP Scan - looks for ICMP unreachable response, but also sends port-specific packets to well-known ports to check for respones |
| -sn    | Network Sweep - Performs light reconnaissance using ping scans and a few other probes to find available hosts without doing port scans. |
| -sV    | Service/Version Info - Probes ports & determines what the service & version are.  OSCP calls this Banner Grabbing |

### Scan Timing

The normal nmap scan timing is `-T3`, but for systems with an IDS/IPs you may need to slow down the scans:

- `-T2` - Waits 0.4 seconds between probes
- `-T1` - Waits 15 seconds between probes
- `-T0` - Waits 5 minutes between each probe

### Other Scan Options

| Option | Description                                                  |
| ------ | ------------------------------------------------------------ |
| -A     | Aggressive scan - Enable OS detection, version detection, script scanning, and traceroute |
| -O     | Enable OS Detection                                          |
| -sC    | Runs the 'default' category of scripts against the target    |

### Nmap Scripting Engine (NSE)

Launch user-created scripts to automate different scanning tasks.  These can range from DNS enumeration, brute force attacks, to vulnerability identification.

Scripts are located in the `/usr/share/nmap/scripts/` folder on Linux and are launched with `--script SCRIPTNAME` or `--script=SCRIPTNAME`, with some examples below:

| Script Name       | Function                                         |
| ----------------- | ------------------------------------------------ |
| smb-os-discovery  | Attempts to connect to SMB server & determine OS |
| dns-zone-transfer | Attempts a DNS zone transfer                     |
|                   |                                                  |

Arguments can be passed to scripts with the `--script-args=OPTION` parameter.

| Option                 | Description                                                  |
| ---------------------- | ------------------------------------------------------------ |
| --script-args=unsafe=1 | Runs risky scans that have a high likelihood of crashing a vulnerable system.  Should be used with extreme caution. |

Scripts can also be called based on category, where all scripts in that category are run.  The scripts are tagged in the `/usr/share/nmap/scripts/script.db` file, which can be grepped to see which scripts fall under which category.  

The categories are listed below (taken from [nmap's site](https://nmap.org/book/nse-usage.html)):

| Category  | Description                                                  |
| --------- | ------------------------------------------------------------ |
| auth      | These scripts deal with authentication credentials (or bypassing them) on the target system. Examples include x11-access, ftp-anon, and oracle-enum-users. Scripts which use brute force attacks to determine credentials are placed in the brute category instead. |
| broadcast | Scripts in this category typically do discovery of hosts not listed on the command line by broadcasting on the local network. Use the newtargets script argument to allow these scripts to automatically add the hosts they discover to the Nmap scanning queue. |
| brute     | These scripts use brute force attacks to guess authentication credentials of a remote server. Nmap contains scripts for brute forcing dozens of protocols, including http-brute, oracle-brute, snmp-brute, etc. |
| default   | These scripts are the default set and are run when using the -sC or -A options rather than listing scripts with --script. This category can also be specified explicitly like any other using --script=default. Many factors are considered in deciding whether a script should be run by default: |
| discovery | These scripts try to actively discover more about the network by querying public registries, SNMP-enabled devices, directory services, and the like. Examples include html-title (obtains the title of the root path of web sites), smb-enum-shares (enumerates Windows shares), and snmp-sysdescr (extracts system details via SNMP). |
| dos       | Scripts in this category may cause a denial of service. Sometimes this is done to test vulnerability to a denial of service method, but more commonly it is an undesired by necessary side effect of testing for a traditional vulnerability. These tests sometimes crash vulnerable services. |
| exploit   | These scripts aim to actively exploit some vulnerability. Examples include jdwp-exec and http-shellshock. |
| external  | Scripts in this category may send data to a third-party database or other network resource. An example of this is whois-ip, which makes a connection to whois servers to learn about the address of the target. There is always the possibility that operators of the third-party database will record anything you send to them, which in many cases will include your IP address and the address of the target. Most scripts involve traffic strictly between the scanning computer and the client; any that do not are placed in this category. |
| fuzzer    | This category contains scripts which are designed to send server software unexpected or randomized fields in each packet. While this technique can useful for finding undiscovered bugs and vulnerabilities in software, it is both a slow process and bandwidth intensive. An example of a script in this category is dns-fuzz, which bombards a DNS server with slightly flawed domain requests until either the server crashes or a user specified time limit elapses. |
| intrusive | These are scripts that cannot be classified in the safe category because the risks are too high that they will crash the target system, use up significant resources on the target host (such as bandwidth or CPU time), or otherwise be perceived as malicious by the target's system administrators. Examples are http-open-proxy (which attempts to use the target server as an HTTP proxy) and snmp-brute (which tries to guess a device's SNMP community string by sending common values such as public, private, and cisco). Unless a script is in the special version category, it should be categorized as either safe or intrusive. |
| malware   | These scripts test whether the target platform is infected by malware or backdoors. Examples include smtp-strangeport, which watches for SMTP servers running on unusual port numbers, and auth-spoof, which detects identd spoofing daemons which provide a fake answer before even receiving a query. Both of these behaviors are commonly associated with malware infections. |
| safe      | Scripts which weren't designed to crash services, use large amounts of network bandwidth or other resources, or exploit security holes are categorized as safe. These are less likely to offend remote administrators, though (as with all other Nmap features) we cannot guarantee that they won't ever cause adverse reactions. Most of these perform general network discovery. Examples are ssh-hostkey (retrieves an SSH host key) and html-title (grabs the title from a web page). Scripts in the version category are not categorized by safety, but any other scripts which aren't in safe should be placed in intrusive. |
| version   | The scripts in this special category are an extension to the version detection feature and cannot be selected explicitly. They are selected to run only if version detection (-sV) was requested. Their output cannot be distinguished from version detection output and they do not produce service or host script results. Examples are skypev2-version, pptp-version, and iax2-version. |
| vuln      | These scripts check for specific known vulnerabilities and generally only report results if they are found. Examples include realvnc-auth-bypass and afp-path-vuln. |

To display more info about a script, use the `--script-help=SCRIPTNAME` option instead.

#### NSE Exploits

NSE also includes scripts for exploiting vulnerabilities as well.  To see these:

```bash
grep Exploits /use/share/nmap/scripts/*.nse
```

### Output Files

Output files provide advantages of the stdout, including the ability to easily grep through the output or to feed the output to other sources such as Dradis.

| Option       | Effect                                                       |
| ------------ | ------------------------------------------------------------ |
| -oG FILENAME | Creates a Greppable output file                              |
| -oX FILENAME | Creates an XML format file                                   |
| -oN FILENAME | Output a 'normal' format file                                |
| -aA BASENAME | Output in the three major formats at once, using the base filename |

#### HTML Output

To convert nmap output to HTML, choose the XML output format from the tool, then use this command to convert it to HTML:

```bash
xsltproc INFILE.xml -o OUTFILE.html
```

### Update Database

1. Check for most recent version here:  https://svn.nmap.org/nmap/

2. Compare with the revision shown in `/usr/share/nmap/nmap-service-probes`

3. Use the `go_update_nmap.sh` script to make a backup of the current files and update them to the newest ones.

4. Modify `/usr/share/nmap/nmap-service-probes` and update this line to reflect the new revision and date updated:

   ```bash
   $Id nmap-service-probes 38147 2020-11-29 13:55:49Z coyote $
   ```

5. Remember to modify your `timeoutms `value if you had changed that.

### Examples

Scan all ports of a host

```bash
nmap -p 10.11.1.220
```

Scan all ports on a range of IP's

```bash
nmap -p 10.11.1.220-240
```

Scan all ports of a host, perform version scanning with 2x verbosity, show only open ports and the reason for the port's state.

```bash
sudo nmap 192.168.216.44 -p- -sV -vv --open --reason
```

Aggressive scan of network, one port, only show open results & store to file

```bash
sudo nmap -A -p80 --open 10.11.1.0/24 -oG namp-scan_10.11.1.1-254


# Options
-A		# Aggressive Scan
-p80	# Scan port 80
--open	# Only return machines with open ports
-oG file	# Output to file in Grepable format
```

Script combo to take the scan results of a host and do further enumeration on them.

```bash
#Do a port scan of all ports and dump ports in comma separated list to variable $ports
ports=$(nmap -p- --min-rate=1000 -T4 10.10.10.27 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)


# Options
grep ^[0-9]  #Grep all lines that begin with digits 0-9
cut -d '/' -f 1	# Removes sections from each line
			# -d '/' #Uses '/' as the delimiter
			# -f 1 #Select the 1st field & cuts the rest
tr '\n' ',' #Translate or delete characters
			# '\n' #match newlines
			# ',' #replace with commas
sed s/,$//	# A  stream editor is used to perform basic text transformations on an input stream
			# s/ #Matches a regular expression
			# ,$ #Regular expression to match (a comma followed by the end of the string)
			/ #Regular expression to replace + ending '/' (replaces with nothing since there's nothing before the /)
```

```bash
# Take comma separated port list and do Service enumeration
nmap -sC -sV -p$ports <host/net>
```

SMB Scanning

```bash
nmap -v -p 139,445 -oG smb.nmap 10.11.1.1-254
```

Pull IP addresses out of a Greppable nmap file:

```bash
grep http *.gnmap | awk -F ": " '{print $2}' | cut -d " " -f 1
```

