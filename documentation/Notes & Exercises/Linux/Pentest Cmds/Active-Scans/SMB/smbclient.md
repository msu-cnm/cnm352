## SMBClient

If connecting to Windows 2016 & higher, Samba needs to be configured with a minimum version of SMBV2 due to Win2016's lack of SMBV1 support.

```bash
# Note:  
vi /etc/samba/smb.conf
# Add this
min protocol = SMB2
```

List shares on a client

```bash
smbclient -L 192.168.216.10 --port=4455 --user=Administrator

# Options
--user=user	# Specify user to connect as, also works with -U
--port=445	# Specify port to connect on
```

Browse a share

```bash
# Creates a connection
smbclient //SERVER/SHARENAME

# Listing directories recursively
recurse
ls
```

Browse to a specific directory on a share (subfolder in the share)

```bash
smbclient //CLOUDBOX/team/ -D "PS" -Uuser%pass -c pwd Domain=[WORKGROUP] OS=[Unix] Server=[Samba 3.6.25]

# Options
-D is the magic option here, idk what the other stuff is for
-c probably runs a command
The rest of the options may just be auth stuff
```

Downloading or Uploading Files from within a share connection

```bash
# Download files
get REMOTEFILE

# Upload files
put LOCALFILE

# Download a folder and its files
mget REMOTEDIR

# Upload a folder and its files
mput LOCALDIR
```

Check a file's attributes

```bash
allinfo FILE
```

### Fix for `protocol negotiation failed: NT_STATUS_CONNECTION_DISCONNECTED`

This error is a result of the client not being able to negotiate the connection because the server's version is too old.  To fix this, add this line to the **global** section of /etc/samba/smb.conf

```bash
client min protocol = LANMAN1
```

Save and restart smbd to apply the changes.

### Automated Share Scan

After performing an nmap scan, create a list of IP's with port 445 open:

```bash
for i in $(grep 445/open/tcp /home/coyote/oscplab/public/enumeration/nmap-scans/*.gnmap | awk -F ": " '{print $2}' | cut -d " " -f 1); do smbmap -H $i 2>/dev/null | grep -v Finding | grep -v Authentication; done;
```

Automated scanning for open shares with directory listing.

```bash
# Feed this file a list of IP's with SMB running
while read i; do smbmap -H $i 2>/dev/null; done < IPFile.txt | grep -v Finding | grep -v Authentication
```
